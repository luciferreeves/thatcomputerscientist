{% extends 'blog/partials/base.html' %} {% block content %}
<link
  rel="stylesheet"
  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai-sublime.min.css"
/>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<style>
  .ql-editor {
    font-family: "Times New Roman", Times, serif;
  }
</style>
<div class="main">
  <section>
    {% include 'blog_admin/partials/posts_topbar.html' %}
    <form action="{% url 'blog-admin:new-post' %}" method="post">
      {% csrf_token %}
      <div class="form-group">
        <label for="title">Title</label>
        <input
          style="display: inline-block"
          type="text"
          class="form-control"
          id="title"
          name="title"
          placeholder="Enter an Amazing Title"
          value="{{ blog_title }}"
        />
      </div>
      <div class="form-group">
        <label for="slug">Slug</label>
          <input
              style="display: inline-block"
              type="text"
              class="form-control"
              id="slug"
              name="slug"
              placeholder="Enter an Amazing Slug"
              value="{{ blog_slug }}"
          />
      </div>
      <div class="form-group">
        <div id="toolbar-container">
          <span class="ql-formats">
            <button class="ql-header" value="1"></button>
            <button class="ql-header" value="2"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
            <button class="ql-strike"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-blockquote"></button>
            <button class="ql-code-block"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-script" value="sub"></button>
            <button class="ql-script" value="super"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
          </span>
          <span class="ql-formats">
            <select class="ql-align"></select>
          </span>
          <span class="ql-formats">
            <button class="ql-link"></button>
            <button class="ql-image"></button>
            <button class="ql-formula"></button>
            {% load static %}
            <button class="ql-formula-block">
              <img
                style="height: 32px; position: relative; top: -6px; left: 4px; filter: invert(1)"
                src="{% static 'images/icons/formula.png' %}"
                alt="Block Formula"
              />
            </button>
          </span>
          <span class="ql-formats">
            <button class="ql-clean"></button>
          </span>
        </div>
        <div id="editor-container" style="height: 60vh"></div>
      </div>
      <div class="form-group">
        <label for="tags">Tags</label>
        <input
          style="display: inline-block"
          type="text"
          class="form-control"
          id="tags"
          name="tags"
          placeholder="Enter Tags"
          value="{{ blog_tags }}"
        />
      </div>
      <div class="form-group">
        <label for="category">Category</label>
          <select class="form-control" id="category" name="category" style = "display: inline-block">
              {% for category in categories %}
              <option value="{{ category.slug }}" {% if category.slug == blog_category %} selected {% endif %}>{{ category.name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="form-group" style="display: none;">
          <textarea name="body" id="body">{{ blog_body }}</textarea>
      </div>
      <div class="form-group">
          <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </section>
</div>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/T-vK/DynamicQuillTools@master/DynamicQuillTools.js"></script>
<script>
  const Parchment = Quill.import("parchment");
  const Delta = Quill.import("delta");
  class MathjaxInline extends Parchment.Embed {
    static create(value) {
      const node = super.create(value);
      if (typeof value === "string") {
        node.innerHTML = "" + this.tex2svg(value) + "";
        node.contentEditable = "false";
        node.setAttribute("data-value", value);
      }
      return node;
    }

    static value(domNode) {
      return domNode.getAttribute("data-value");
    }

    static tex2svg(latex) {
      let MathJaxNode = document.createElement("DIV");
      MathJaxNode.style.visibility = "hidden";
      MathJaxNode.innerHTML = "\\(" + latex + "\\)";
      document.body.appendChild(MathJaxNode);
      MathJax.typeset();
      let svg = MathJaxNode.innerHTML;
      document.body.removeChild(MathJaxNode);
      return svg;
    }
  }

  class MathjaxBlock extends Parchment.Embed {
    static create(value) {
      const node = super.create(value);
      if (typeof value === "string") {
        node.innerHTML = "" + this.tex2svg(value) + "";
        node.contentEditable = "false";
        node.setAttribute("data-value", value);
      }
      return node;
    }

    static value(domNode) {
      return domNode.getAttribute("data-value");
    }

    static tex2svg(latex) {
      let MathJaxNode = document.createElement("DIV");
      MathJaxNode.style.visibility = "hidden";
      MathJaxNode.innerHTML = "\\[" + latex + "\\]";
      document.body.appendChild(MathJaxNode);
      MathJax.typeset();
      let svg = MathJaxNode.innerHTML;
      document.body.removeChild(MathJaxNode);
      return svg;
    }
  }

  // Set module properties
  MathjaxInline.blotName = "mathjax-inline";
  MathjaxInline.className = "ql-mathjax-inline";
  MathjaxInline.tagName = "SPAN";
  MathjaxBlock.blotName = "mathjax-block";
  MathjaxBlock.className = "ql-mathjax-block";
  MathjaxBlock.tagName = "DIV";

  // Register the module
  Quill.register(MathjaxInline);
  Quill.register(MathjaxBlock);

  function insertFormula(quill, block) {
    var range = quill.getSelection();
    var latex = prompt(
      "Enter a LaTeX formula",
      quill.getText(range) == "" ? "e=mc^2" : quill.getText(range)
    );
    quill.deleteText(range.index, range.length);
    if (block) {
      quill.insertEmbed(range.index, "mathjax-block", latex);
    } else {
      quill.insertEmbed(range.index, "mathjax-inline", latex);
    }
    quill.insertText(range.index + range.length + 1, " ");
    quill.setSelection(range.index + range.length + 1);
  }

  var quill = new Quill("#editor-container", {
    modules: {
      syntax: true,
      toolbar: {
        container: "#toolbar-container",
        handlers: {
          formula: function () {
            insertFormula(quill, false);
          },
          "formula-block": function () {
            insertFormula(quill, true);
          },
        },
      },
    },
    placeholder: "Compose an epic...",
    theme: "snow",
  });

  // update body on text change
    quill.on("text-change", function (delta, oldDelta, source) {
        document.getElementById("body").value = quill.root.innerHTML;
    });

    function slugify(text) {
        return text
            .toString()
            .toLowerCase()
            .replace(/\s+/g, "-") // Replace spaces with -
            .replace(/[^\w\-]+/g, "") // Remove all non-word chars
            .replace(/\-\-+/g, "-") // Replace multiple - with single -
            .replace(/^-+/, "") // Trim - from start of text
            .replace(/-+$/, ""); // Trim - from end of text
    }

    // slugify title
    document.getElementById("title").addEventListener("input", function () {
        document.getElementById("slug").value = slugify(this.value);
    });

    try {
      const value = document.getElementById("body").value;
      const newValue = value.replace(/<p><br><\/p>/g, "");
      const delta = quill.clipboard.convert(value);
        quill.setContents(delta, "silent");
    } catch (e) {
        console.log(e);
    }
</script>
{% endblock %}
