{% extends 'blog/partials/base.html' %} {% block content %}
{% load static %}
{% load tz %}
<div id="post-actions-bar" class="mtsbitem">
    <a class="pa-btn" href="#article-body">Article</a>
    <a class="pa-btn" href="#comments">Opinions</a>
    <a class="pa-btn" href="#new-comment">Your Thoughts?</a>
    {% comment %} <a class="pa-btn" id="translate-jp" href="javascript:;">
        <img src="{% static 'images/icons/translate.png' %}" alt="Translate to Japanese" style="height: 11px; width: 11px; margin-right: 5px; position: relative; top: 1px;">
        {% if request.session.language == 'jp' %}
            Translate to English
        {% else %}
            Translate to Japanese
        {% endif %}
    </a> {% endcomment %}
</div>
<div id="article">
    <h1 style="padding: 20px 0; margin: 0; text-align: left; font-size: 32px; font-weight: bold; color: #f4ebff;">
        {{ post.title }}
    </h1>
    <div style="margin: 10px 0px 10px 0px; display: inline-block;">
        {% with post.author.userprofile_set.first as userprofile %}
        <div style="height: 20px; width: 20px; display: inline-block; margin-right: 4px; border-radius: 10px; background-image: url('{% static 'images/avatars/' %}{{ userprofile.avatar_url }}.gif'); background-size: cover; background-position: center;"></div>
        {% endwith %}
        <div style="display: inline-block; vertical-align: top;">
            <a href="{% url 'blog:user_activity' post.author %}" style="font-weight: bold; font-size: 11px; position: relative; top: 2.5px;">
                {{ post.author.first_name }} {{ post.author.last_name }}
            </a>
            <span style="position: relative; top: 2.5px;">posted in</span>
            <a href="{% url 'blog:categories' %}/{{ post.category.slug }}" style="position: relative; top: 2.5px;">
                {{ post.category }}
            </a>
            <span style="position: relative; top: 2.5px; margin-left: 4px;"><b>|</b></span>
            <span style="position: relative; top: 2.5px; margin-left: 4px;">{% localtime on %}{{ post.date | date:"M d, Y" }}{% endlocaltime %}</span>
        </div>
    </div>

    <div id="article-body">
        <div>{{ post.first_paragraph | safe }}</div>
        <div style="width: 710px; height: 473.3333px; margin: 20px auto; display: block; border-radius: 8px; background-image: url('{% url 'ignis:post_image' '710' post.id %}.gif'); background-size: cover; background-position: center;"></div>
        <div>{{ post.body | safe }}</div>
    </div>
</div>

<h2 class="mtsbitem">Comments
    <a href="#article" class="pa-btn" style="float: right; margin-top: 5px; text-transform: capitalize; font-weight: normal;">
        Back to Top
    </a>
</h2>
{% if comments %}
<div id="comments" style="clear: both;">
    {% for comment in comments %}
        <div id="comment-{{ comment.id }}">
            <table>
                <tr>
                    <td style="width: 60px; vertical-align: top;">
                        <img src="{% static 'images/avatars/' %}{{ comment.avatar_url }}.gif" alt="Profile Picture" style="width: 50px;">
                    </td>
                    <td style="vertical-align: top; width: 668px;">
                        <div style="margin-bottom: 13px; border-bottom: dashed 1px white; padding-bottom: 13px;">
                            <a href="{% url 'blog:user_activity' comment.user.username %}">{{ comment.user.username }}</a> on <em>{{ comment.created_at | date:"M d, Y" }}</em>
                            {% if comment.edited %}
                                <em>(Edited)</em>
                            {% endif %}
                            {% if comment.user == user %}
                                &nbsp;&nbsp;
                                <a href="javascript:;" onclick="editComment({{ comment.id }})">Edit</a>
                                &nbsp;&nbsp;
                                <a href="{% url 'blog:delete_comment' post.slug comment.id %}" onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
                            {% endif %}
                        </div>
                        <div id="comment-body-{{ comment.id }}" class="comment">
                            {{ comment.processed_body|safe }}
                        </div>
                        {% if comment.user == user %}
                        <div id="edit-form-{{ comment.id }}" style="display: none; margin-bottom: 20px;">
                            <form action="{% url 'blog:edit_comment' post.slug %}" method="POST">
                                {% csrf_token %}
                                <input type = "hidden" name="comment_id" value="{{ comment.id }}">
                                <textarea name="body" id="body" cols="78" rows="10" style="width: 640px; display: block; margin-bottom: 10px;">{{ comment.body }}</textarea>
                                <input type="submit" value="Update" class="button button-special">
                                <input type="button" value="Cancel" onclick="cancelEdit({{ comment.id }})" class="button">
                            </form>
                        </div>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    {% endfor %}
</div>
{% else %}
<div id="comments" style="clear: both;">
    <p><em>Sadly, there are no comments yet. Be the first to leave one!</em></p>
</div>
{% endif %}

{% if user.is_authenticated %}
<div id="new-comment">
    <h2>Leave a Comment</h2>
    <form action="{% url 'blog:comment' post.slug %}" method="POST">
        {% csrf_token %}
        <textarea name="comment" id="comment" cols="88" rows="10" style="width: 710px; display: block; margin-bottom: 15px;" placeholder="Your comment here..."></textarea>
        <input type="submit" value="Submit" class="button button-special">
    </form>
</div>
<div id="comment-tips" style="background-color: #2d1d3d;padding: 10px;margin-bottom: 15px;border-radius: 6px; margin-top: 15px;">
    <span onclick="toggleTips()" style="cursor: pointer; border-bottom: dotted 1px white;" class="noselect">Text Markup Tips &gt;</span>
    <div id="tips" style="display: none;">
        <br>
        <ul style="list-style-type: disc; margin: 0;padding: 0; margin: 5px 0px 0px 30px;">
            <li>Wrap text in double underscores (__) to make it <i>italic</i>.
                <br>
                &nbsp;&nbsp;e.g. <code>__italic__</code>
                &nbsp;&nbsp;shortkey: <kbd>Ctrl or Cmd + I</kbd>
                <br><br>
            </li>
            <li>Wrap text in double asterisks (**) to make it <b>bold</b>.
                <br>
                &nbsp;&nbsp;e.g. <code>**bold**</code>
                &nbsp;&nbsp;shortkey: <kbd>Ctrl or Cmd + B</kbd>
                <br><br>
            </li>
            <li>Wrap text in double tildes (~~) to <s>strikethrough</s> it.
                <br>
                &nbsp;&nbsp;e.g. <code>~~strikethrough~~</code>
                &nbsp;&nbsp;shortkey: <kbd>Ctrl or Cmd + D</kbd>
                <br><br>
            </li>
            <li>Wrap text in triple backticks (```) to make it a code block.
                <br>
                &nbsp;&nbsp;e.g. <code>```code block```</code>, 
                &nbsp;&nbsp;shortkey: <kbd>Ctrl or Cmd + K</kbd>
                <br><br>
            </li>
            <li>Wrap text in double dollar sign ($$) to make it a math block and single dollar sign ($) to make it inline math. You can use LaTeX syntax.
                <br>
                &nbsp;&nbsp;e.g. <code>$$\frac{1}{2}$$</code> or <code>$\frac{1}{2}$</code>
                <br><br>
            </li>
        </ul>
        <p style="margin-top: -7px;">Any links, images or other markup will be kept as plain text. Also, free speech is good and all, but please keep it civil. Sufficient JavaScript support will be required to bind shortkeys. Please type the markup manually if you are on an older browser.</p>
    </div>
</div>
{% else %}
<div id="new-comment" class="mtsbitem">
    <h2>Leave a Comment</h2>
    <p><em>You must be logged in to leave a comment.</em></p>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script type="text/javascript">
    function editComment(id) {
        document.getElementById('comment-body-' + id).style.display = 'none';
        document.getElementById('edit-form-' + id).style.display = 'block';
    }

    function cancelEdit(id) {
        document.getElementById('comment-body-' + id).style.display = 'block';
        document.getElementById('edit-form-' + id).style.display = 'none';
    }

    function toggleTips() {
        var tips = document.getElementById('tips');
        if (tips.style.display == 'none') {
            tips.style.display = 'block';
        } else {
            tips.style.display = 'none';
        }
    }

    var textareas = $('textarea');

    function insertAtCursor(field, text) {
        if (field.createTextRange) {
            var range = field.createTextRange();
            range.collapse(true);
            range.moveStart('character', text.length);
            range.select();
        } else if (field.setSelectionRange) {
            var start = field.selectionStart;
            field.value = field.value.substring(0, start) + text + field.value.substring(field.selectionEnd);
            field.setSelectionRange(start + text.length, start + text.length);
            field.focus();
        }
    }

    function handleKeyDown(e) {
        var field = e.target;
        if (e.keyCode == 66 && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            insertAtCursor(field, '**');
        } else if (e.keyCode == 73 && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            insertAtCursor(field, '__');
        } else if (e.keyCode == 68 && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            insertAtCursor(field, '~~');
        } else if (e.keyCode == 75 && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            insertAtCursor(field, '```');
        } else if (e.keyCode == 9) {
            e.preventDefault();
            var start = field.selectionStart;
            var end = field.selectionEnd;
            field.value = field.value.substring(0, start) + '    ' + field.value.substring(end);
            field.setSelectionRange(start + 4, end + 4);
        }
    }

    for (var i = 0; i < textareas.length; i++) {
        textareas[i].onkeydown = handleKeyDown;
    }

    //pa-btn scroll animate override
    $('.pa-btn').click(function() {
        $('html, body').animate({
            scrollTop: $($(this).attr('href')).offset().top - 50
        }, 500);
        return false;
    });
</script>

{% include 'blog/partials/mathjax.html' %}
{% endblock %}

