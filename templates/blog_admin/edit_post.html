{% extends 'blog/partials/base.html' %} {% block content %} {% load static %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<style>
  button {
    color: #444;
  }
  textarea#body {
    margin: 10px 0 0 0;
    width: 710px;
    height: 400px;
  }
</style>
<h1>Editing Post: {{ post.title }}</h1>
<div style="max-width: 730px">
  <div id="toolbar-container">
    <span class="ql-formats">
      <button class="ql-header" value="1"></button>
      <button class="ql-header" value="2"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-strike"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-blockquote"></button>
      <button class="ql-code-block"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-script" value="sub"></button>
      <button class="ql-script" value="super"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
    </span>
    <span class="ql-formats">
      <select class="ql-align"></select>
    </span>
    <span class="ql-formats">
      <button class="ql-link"></button>
      <button class="ql-image"></button>
    </span>
    <span class="ql-formats">
      <button class="ql-clean"></button>
      <button class="ql-html" onclick="toggleHTML()">HTML</button>
    </span>
  </div>
  <div id="editor-container"></div>
  <form action="{% url 'blog-admin:edit-post' post.slug %}" method="post">
    {% csrf_token %}
    <div style="display: none" id="HTMLContent">
      <textarea name="body" id="body">{{ post.body }}</textarea>
    </div>
    <br />
    <button type="submit" class="button button-special">Save</button>
  </form>
</div>
{% endblock %} {% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  const Delta = Quill.import("delta");
  let BlockEmbed = Quill.import("blots/block/embed");

  class ImageBlock extends BlockEmbed {
    static create(value) {
      let node = super.create();
      node.setAttribute("src", value.url);

      if (value.size == "block") {
        node.classList.add("block");
      }

      return node;
    }

    static value(node) {
      return {
        url: node.getAttribute("src"),
      };
    }

    html() {
      const { url } = this.value();
      return `<img src="${url}">`;
    }

    static blotName = "image";
    static tagName = "img";
  }

  Quill.register(ImageBlock);

  function imageUpload(formData, quill, range, size) {
    const imageURL = "{% url 'ignis:upload_image' %}";
    const headers = {
      "X-CSRFToken": "{{ csrf_token }}",
    };
    $.ajax({
      url: imageURL,
      type: "POST",
      headers: headers,
      data: formData,
      processData: false,
      contentType: false,
      success: function (data) {
        const imageURL = data.url;
        quill.updateContents(
          new Delta()
            .retain(range.index)
            .delete(range.length)
            .insert({ image: { url: imageURL, size: size } })
        );
      },
      error: function (err) {
        console.log(err);
      },
    });
  }
  
  class CodeBlock extends Quill.import("formats/code-block") {
    static create(value) {
      let domNode = super.create();
      domNode.setAttribute("data-language", value);
      return domNode;
    }
  }

  CodeBlock.blotName = "code-block";
  CodeBlock.tagName = "pre";
  Quill.register(CodeBlock);

  const quill = new Quill("#editor-container", {
    modules: {
      toolbar: {
        container: "#toolbar-container",
        handlers: {
          "code-block": function() {
            const language = prompt("Enter language", "text");
            this.quill.format("code-block", language);

          },
          image: function () {
            var size = prompt(
              "Set Image Size: 0 (default) for inline, 1 for block",
              "0"
            );
            if (size == "0") {
              size = "";
            } else if (size == "1") {
              size = "block";
            } else {
              size = "";
            }
            let fileInput = this.container.querySelector(
              "input.ql-image[type=file]"
            );
            if (fileInput == null) {
              fileInput = document.createElement("input");
              fileInput.setAttribute("type", "file");
              fileInput.setAttribute(
                "accept",
                "image/png, image/gif, image/jpeg, image/bmp, image/x-icon"
              );
              fileInput.classList.add("ql-image");
              fileInput.addEventListener("change", () => {
                if (fileInput.files != null && fileInput.files[0] != null) {
                  let range = this.quill.getSelection(true);
                  const formData = new FormData();
                  formData.append("image", fileInput.files[0]);
                  formData.append("id", "{{ post.id }}");
                  const imageURL = imageUpload(formData, this.quill, range, size);
                  fileInput.value = "";
                }
              });
              this.container.appendChild(fileInput);
            }
            fileInput.click();
          },
        },
      },
    },
    placeholder: "Compose an epic...",
    theme: "snow",
  });

  var content = $("#body").val();
  content = content.replace(/<p><br><\/p>/g, "");
  //quill.setContents(quill.clipboard.convert(content), "silent");
  quill.clipboard.dangerouslyPasteHTML(0, content);
  quill.on("text-change", function (delta, oldDelta, source) {
      document.getElementById("body").value = quill.root.innerHTML;
  });

  function toggleHTML() {
    $("#HTMLContent").toggle();
  }

  
</script>
{% endblock %} 