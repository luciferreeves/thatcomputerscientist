{% extends 'blog/partials/base.html' %} {% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<div class="main">
  <section>
    <div class="article-cover">
      <img src="{% url 'ignis:post_image' '730' post.id %}.gif" alt="Cover Image" style="width: 730px; margin: 0 auto; display: block;">
    </div>
    <br>
    <form action="{% url 'blog-admin:edit-post' blog_slug %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-group">
        <label for="title">Title</label>
        <input
          style="display: inline-block"
          type="text"
          class="form-control"
          id="title"
          name="title"
          placeholder="Enter an Amazing Title"
          value="{{ blog_title }}"
        />
      </div>
      {% comment %} <br> {% endcomment %}
      <div class="form-group">
        {% comment %} <label for="slug">Slug</label> {% endcomment %}
          <input
              style="display: inline-block"
              type="hidden"
              class="form-control"
              id="slug"
              name="slug"
              placeholder="Enter an Amazing Slug"
              value="{{ blog_slug }}"
          />
      </div>
      <div class="form-group">
        <input
            style="display: inline-block"
            type="hidden"
            class="form-control"
            id="post_id"
            name="post_id"
            value="{{ post.id }}"
        />
    </div>
      <br>
      <div class="form-group">
        <label for="content">Post Image</label>
        <input
          style="display: inline-block"
          type="file"
          class="form-control"
          id="post_image"
          name="post_image"
        />
      </div>
      <br>

      <div class="form-group">
        <div id="toolbar-container">
          <span class="ql-formats">
            <button class="ql-header" value="1"></button>
            <button class="ql-header" value="2"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
            <button class="ql-strike"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-blockquote"></button>
            <button class="ql-code-block"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-script" value="sub"></button>
            <button class="ql-script" value="super"></button>
          </span>

          <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
          </span>
          <span class="ql-formats">
            <select class="ql-align"></select>
          </span>
          <span class="ql-formats">
            <button class="ql-link"></button>
            <button class="ql-image"></button>
            <button class="ql-formula"></button>
            {% load static %}
            <button class="ql-formula-block">
              <img
                style="height: 32px; position: relative; top: -6px; left: 4px; filter: invert(1)"
                src="{% static 'images/icons/formula.png' %}"
                alt="Block Formula"
              />
            </button>
          </span>
          <span class="ql-formats">
            <button class="ql-clean"></button>
          </span>
        </div>
        <div id="editor-container" style="height: 60vh"></div>
      </div>
      <br>
      <div class="form-group">
        <label for="tags">Tags</label>
        <input
          style="display: inline-block"
          type="text"
          class="form-control"
          id="tags"
          name="tags"
          placeholder="Enter Tags"
          value="{{ blog_tags }}"
        />
      </div>
      <br>
      <div class="form-group">
        <label for="category">Category</label>
          <select class="form-control" id="category" name="category" style = "display: inline-block">
              {% for category in categories %}
              <option value="{{ category.slug }}" {% if category.slug == blog_category %} selected {% endif %}>{{ category.name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="form-group" style="display: none;">
          <textarea name="body" id="body">{{ blog_body }}</textarea>
      </div>
      <br>
      <div class="form-group">
          <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </section>
</div>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  const Parchment = Quill.import("parchment");
  const Delta = Quill.import("delta");
  class MathjaxInline extends Parchment.Embed {
    static create(value) {
      const node = super.create(value);
      if (typeof value === "string") {
        node.innerHTML = this.gettex(value);
        node.contentEditable = "false";
        node.setAttribute("data-value", value);
      }
      return node;
    }

    static value(domNode) {
      return domNode.getAttribute("data-value");
    }

    static gettex(latex) {
      // make a GET request to /tex, returns a png response. render this to image tag
      const url = `/ignis/tex?expr="${latex.replace(/'/g, '%27')}"`;
      const img = `<img src='${url}' style="display: inline-block;margin: 0 auto;height: auto;max-height: 16px;vertical-align: middle;" />`;
      return img;

    }
  }

  class MathjaxBlock extends Parchment.Embed {
    static create(value) {
      const node = super.create(value);
      if (typeof value === "string") {
        node.innerHTML = "" + this.gettex(value);
        node.contentEditable = "false";
        node.setAttribute("data-value", value);
      }
      return node;
    }

    static value(domNode) {
      return domNode.getAttribute("data-value");
    }

    static gettex(latex) {
      // make a POST request to /tex, returns a png response. render this to image tag
     
      const url = `/ignis/tex?expr="${latex.replace(/'/g, '%27')}"`;
      const img = `<img src='${url}' display: block; margin-left: auto; margin-right: auto; height: auto; max-height: 120px;" />`;
      return img;
    }
  }
  
  // Set module properties
  MathjaxInline.blotName = "mathjax-inline";
  MathjaxInline.className = "ql-mathjax-inline";
  MathjaxInline.tagName = "SPAN";
  MathjaxBlock.blotName = "mathjax-block";
  MathjaxBlock.className = "ql-mathjax-block";
  MathjaxBlock.tagName = "DIV";

  // Register the module
  Quill.register(MathjaxInline);
  Quill.register(MathjaxBlock);

  function insertFormula(quill, block) {
    var range = quill.getSelection();
    var latex = prompt(
      "Enter a LaTeX formula",
      quill.getText(range) == "" ? "e=mc^2" : quill.getText(range)
    );
    quill.deleteText(range.index, range.length);
    if (block) {
      quill.insertEmbed(range.index, "mathjax-block", latex);
    } else {
      quill.insertEmbed(range.index, "mathjax-inline", latex);
    }
    quill.insertText(range.index + range.length + 1, " ");
    quill.setSelection(range.index + range.length + 1);
  }

  var quill = new Quill("#editor-container", {
    modules: {
      toolbar: {
        container: "#toolbar-container",
        handlers: {
          formula: function () {
            insertFormula(quill, false);
          },
          "formula-block": function () {
            insertFormula(quill, true);
          },
          image: function () {
            // open image upload dialog
            let fileInput = this.container.querySelector('input.ql-image[type=file]');
            if (fileInput == null) {
              fileInput = document.createElement('input');
              fileInput.setAttribute('type', 'file');
              fileInput.setAttribute('accept', 'image/png, image/gif, image/jpeg, image/bmp, image/x-icon');
              fileInput.classList.add('ql-image');
              fileInput.addEventListener('change', () => {
                if (fileInput.files != null && fileInput.files[0] != null) {
                  let range = this.quill.getSelection(true);
                  const url = "/ignis/upload";
                  const formData = new FormData();
                  formData.append("image", fileInput.files[0]);
                  formData.append("id", document.getElementById("post_id").value);
                  // append csrf token in header
                  const headers = new Headers();
                  headers.append("X-CSRFToken", "{{ csrf_token }}");

                  fetch(url, {
                    method: "POST",
                    headers: headers,
                    body: formData,
                  }).then((response) => response.json()).then((result) => {
                    this.quill.updateContents(new Delta()
                      .retain(range.index)
                      .delete(range.length)
                      .insert({ image: result.url })
                    , Quill.sources.USER);
                    fileInput.value = "";
                  }).catch((error) => {
                    console.error("Error:", error);
                  });

                  /* let reader = new FileReader();
                    reader.onload = (e) => {
                      // this.quill.insertEmbed(range.index, "image", result.url);
                      // this.quill.setSelection(range.index + 1);
                  }
                  reader.readAsDataURL(fileInput.files[0]); */
                }
              });
              this.container.appendChild(fileInput);
            }
            fileInput.click();
          },
        },
      },
    },
    placeholder: "Compose an epic...",
    theme: "snow",
  });

  // update body on text change
    quill.on("text-change", function (delta, oldDelta, source) {
        document.getElementById("body").value = quill.root.innerHTML;
    });

    function slugify(text) {
        return text
            .toString()
            .toLowerCase()
            .replace(/\s+/g, "-") // Replace spaces with -
            .replace(/[^\w\-]+/g, "") // Remove all non-word chars
            .replace(/\-\-+/g, "-") // Replace multiple - with single -
            .replace(/^-+/, "") // Trim - from start of text
            .replace(/-+$/, ""); // Trim - from end of text
    }

    // slugify title
    document.getElementById("title").addEventListener("input", function () {
        document.getElementById("slug").value = slugify(this.value);
    });

    try {
      const value = document.getElementById("body").value;
      const newValue = value.replace(/<p><br><\/p>/g, "");
      const delta = quill.clipboard.convert(value);
        quill.setContents(delta, "silent");
    } catch (e) {
        console.log(e);
    }
</script>
{% endblock %}
